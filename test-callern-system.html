<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallerN System Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h2 {
            margin-top: 0;
            color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .log {
            background: #282c34;
            color: #61dafb;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 10px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #61dafb;
            padding-left: 10px;
        }
        .success {
            color: #4caf50;
            border-left-color: #4caf50;
        }
        .error {
            color: #f44336;
            border-left-color: #f44336;
        }
        .warning {
            color: #ff9800;
            border-left-color: #ff9800;
        }
        .info {
            color: #2196f3;
            border-left-color: #2196f3;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.connected {
            background: #4caf50;
            color: white;
        }
        .status.disconnected {
            background: #f44336;
            color: white;
        }
        .status.pending {
            background: #ff9800;
            color: white;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        video {
            width: 300px;
            height: 200px;
            background: #000;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ CallerN System Test Report</h1>
        
        <!-- Login Section -->
        <div class="section">
            <h2>1. Authentication <span id="auth-status" class="status disconnected">Not Logged In</span></h2>
            <div>
                <input type="email" id="email" placeholder="Email" value="student1@test.com">
                <input type="password" id="password" placeholder="Password" value="Test@123">
                <button onclick="testLogin('student')">Login as Student</button>
                <button onclick="testLogin('teacher')">Login as Teacher</button>
            </div>
            <div id="auth-log" class="log"></div>
        </div>

        <!-- Socket Connection Section -->
        <div class="section">
            <h2>2. WebSocket Connection <span id="socket-status" class="status disconnected">Disconnected</span></h2>
            <button onclick="connectSocket()" id="connect-btn">Connect Socket</button>
            <button onclick="disconnectSocket()" disabled id="disconnect-btn">Disconnect Socket</button>
            <div id="socket-log" class="log"></div>
        </div>

        <!-- CallerN Call Test Section -->
        <div class="section">
            <h2>3. CallerN Video Call Test</h2>
            <div>
                <button onclick="startCallAsStudent()" id="start-call-btn" disabled>Start Call (Student)</button>
                <button onclick="acceptCallAsTeacher()" id="accept-call-btn" disabled>Accept Call (Teacher)</button>
                <button onclick="endCall()" id="end-call-btn" disabled>End Call</button>
            </div>
            <div id="call-log" class="log"></div>
            <div class="video-container">
                <div>
                    <h4>Local Video</h4>
                    <video id="localVideo" autoplay muted></video>
                </div>
                <div>
                    <h4>Remote Video</h4>
                    <video id="remoteVideo" autoplay></video>
                </div>
            </div>
        </div>

        <!-- Test Results Section -->
        <div class="section">
            <h2>4. Test Results Summary</h2>
            <div id="results-log" class="log"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let socket = null;
        let currentUser = null;
        let roomId = null;
        let peer = null;
        let localStream = null;

        function log(section, message, type = 'info') {
            const logEl = document.getElementById(`${section}-log`);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const el = document.getElementById(elementId);
            el.className = `status ${status}`;
            el.textContent = text;
        }

        async function testLogin(role) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Set appropriate test credentials
            if (role === 'teacher') {
                document.getElementById('email').value = 'teacher1@test.com';
                document.getElementById('password').value = 'password';
            }
            
            log('auth', `Attempting login as ${role}...`, 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: document.getElementById('email').value, 
                        password: document.getElementById('password').value 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.auth_token) {
                    authToken = data.auth_token;  // Changed from data.token to data.auth_token
                    currentUser = data.user;
                    localStorage.setItem('auth_token', authToken);
                    log('auth', `âœ“ Login successful! User: ${currentUser.email} (${currentUser.role})`, 'success');
                    updateStatus('auth-status', 'connected', `Logged in as ${currentUser.role}`);
                    document.getElementById('connect-btn').disabled = false;
                } else {
                    log('auth', `âœ— Login failed: ${data.message}`, 'error');
                    updateStatus('auth-status', 'disconnected', 'Login Failed');
                }
            } catch (error) {
                log('auth', `âœ— Login error: ${error.message}`, 'error');
            }
        }

        function connectSocket() {
            if (!authToken) {
                log('socket', 'âœ— Please login first', 'error');
                return;
            }
            
            // Check if socket.io is loaded
            if (typeof io === 'undefined') {
                log('socket', 'âœ— Socket.io library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            log('socket', 'Connecting WebSocket...', 'info');
            
            // Connect without auth in options - will authenticate after connection
            socket = io(window.location.origin, {
                path: '/socket.io/',
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                log('socket', `âœ“ Socket connected! ID: ${socket.id}`, 'success');
                updateStatus('socket-status', 'connected', 'Connected');
                document.getElementById('connect-btn').disabled = true;
                document.getElementById('disconnect-btn').disabled = false;
                
                // Authenticate after connection
                log('socket', `Authenticating as ${currentUser.role} (ID: ${currentUser.id})...`, 'info');
                socket.emit('authenticate', {
                    userId: currentUser.id,
                    role: currentUser.role
                });
            });
            
            // Listen for authentication confirmation
            socket.on('authenticated', (data) => {
                if (data.success) {
                    log('socket', `âœ“ Authenticated successfully as ${data.role}`, 'success');
                    
                    if (currentUser.role === 'Student') {
                        document.getElementById('start-call-btn').disabled = false;
                    } else if (currentUser.role === 'Teacher') {
                        document.getElementById('accept-call-btn').disabled = false;
                    }
                } else {
                    log('socket', 'âœ— Authentication failed', 'error');
                }
            });
            
            socket.on('disconnect', () => {
                log('socket', 'âœ— Socket disconnected', 'warning');
                updateStatus('socket-status', 'disconnected', 'Disconnected');
                document.getElementById('connect-btn').disabled = false;
                document.getElementById('disconnect-btn').disabled = true;
            });
            
            // CallerN event handlers
            socket.on('incoming-call', (data) => {
                log('call', `ðŸ“ž Incoming call from student ${data.studentId}`, 'info');
                document.getElementById('accept-call-btn').disabled = false;
                roomId = data.roomId;
            });
            
            socket.on('call-accepted', (data) => {
                log('call', 'âœ“ Call accepted by teacher!', 'success');
                setupWebRTC(true);
            });
            
            socket.on('call-rejected', (data) => {
                log('call', `âœ— Call rejected: ${data.reason}`, 'error');
            });
            
            socket.on('user-joined', (data) => {
                log('call', `User joined room: ${data.role} (Socket: ${data.socketId})`, 'info');
                if (currentUser.role === 'student' && data.role === 'teacher') {
                    setupWebRTC(true);
                }
            });
            
            socket.on('offer', async (data) => {
                log('call', 'Received WebRTC offer', 'info');
                await handleOffer(data);
            });
            
            socket.on('answer', async (data) => {
                log('call', 'Received WebRTC answer', 'info');
                await handleAnswer(data);
            });
            
            socket.on('ice-candidate', async (data) => {
                log('call', 'Received ICE candidate', 'info');
                await handleIceCandidate(data);
            });
            
            socket.on('error', (error) => {
                log('socket', `âœ— Socket error: ${error.message || error}`, 'error');
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        async function startCallAsStudent() {
            if (!socket || currentUser.role !== 'student') {
                log('call', 'âœ— Must be logged in as student with active socket', 'error');
                return;
            }
            
            roomId = `test-room-${Date.now()}`;
            log('call', `Starting call with room ID: ${roomId}`, 'info');
            
            // Join room first
            socket.emit('join-room', {
                roomId: roomId,
                userId: currentUser.id,
                role: 'student'
            });
            
            // Request call to teacher
            socket.emit('call-teacher', {
                teacherId: 73, // Teacher ID from test data
                studentId: currentUser.id,
                packageId: 1, // Test package ID
                language: 'english',
                roomId: roomId
            });
            
            log('call', 'Call request sent to teacher', 'info');
            document.getElementById('end-call-btn').disabled = false;
        }

        async function acceptCallAsTeacher() {
            if (!socket || !roomId || currentUser.role !== 'teacher') {
                log('call', 'âœ— No incoming call to accept', 'error');
                return;
            }
            
            log('call', 'Accepting call...', 'info');
            
            socket.emit('accept-call', {
                roomId: roomId,
                teacherId: currentUser.id,
                studentId: 8469 // Student ID from test data
            });
            
            document.getElementById('end-call-btn').disabled = false;
            
            // Join room and setup WebRTC
            socket.emit('join-room', {
                roomId: roomId,
                userId: currentUser.id,
                role: 'teacher'
            });
            
            await setupWebRTC(false);
        }

        async function setupWebRTC(isInitiator) {
            log('call', `Setting up WebRTC as ${isInitiator ? 'initiator' : 'receiver'}`, 'info');
            
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                log('call', 'âœ“ Local media stream obtained', 'success');
                
                // Create peer connection
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                const SimplePeer = window.SimplePeer || null;
                if (!SimplePeer) {
                    log('call', 'âœ— SimplePeer not loaded', 'error');
                    return;
                }
                
                peer = new SimplePeer({
                    initiator: isInitiator,
                    stream: localStream,
                    config: config
                });
                
                peer.on('signal', (signal) => {
                    if (signal.type === 'offer') {
                        socket.emit('offer', {
                            roomId: roomId,
                            offer: signal,
                            to: null // Will be handled by server
                        });
                    } else if (signal.type === 'answer') {
                        socket.emit('answer', {
                            roomId: roomId,
                            answer: signal,
                            to: null // Will be handled by server
                        });
                    } else {
                        socket.emit('ice-candidate', {
                            roomId: roomId,
                            candidate: signal,
                            to: null // Will be handled by server
                        });
                    }
                });
                
                peer.on('stream', (remoteStream) => {
                    log('call', 'âœ“ Remote stream received', 'success');
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
                
                peer.on('connect', () => {
                    log('call', 'âœ“ Peer connection established!', 'success');
                    log('results', 'âœ… CallerN video call successfully connected!', 'success');
                });
                
                peer.on('error', (err) => {
                    log('call', `âœ— Peer error: ${err}`, 'error');
                });
                
            } catch (error) {
                log('call', `âœ— WebRTC setup error: ${error.message}`, 'error');
            }
        }

        async function handleOffer({ offer, from }) {
            if (peer) {
                peer.signal(offer);
            }
        }

        async function handleAnswer({ answer, from }) {
            if (peer) {
                peer.signal(answer);
            }
        }

        async function handleIceCandidate({ candidate }) {
            if (peer) {
                peer.signal(candidate);
            }
        }

        function endCall() {
            log('call', 'Ending call...', 'info');
            
            if (peer) {
                peer.destroy();
                peer = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            if (socket && roomId) {
                socket.emit('leave-room', { roomId });
            }
            
            document.getElementById('end-call-btn').disabled = true;
            log('call', 'âœ“ Call ended', 'success');
        }

        // Initialize
        log('results', 'CallerN System Test initialized', 'info');
        log('results', 'Test Steps:', 'info');
        log('results', '1. Login as Student or Teacher', 'info');
        log('results', '2. Connect WebSocket', 'info');
        log('results', '3. Student: Start Call | Teacher: Accept Call', 'info');
        log('results', '4. Verify video/audio connection', 'info');
    </script>
</body>
</html>