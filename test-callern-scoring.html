<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallerN Video Call Test with Scoring</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-student {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-teacher {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .btn-call {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .videos-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .video-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
        }
        
        .logs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .logs-content {
            background: #1f2937;
            border-radius: 12px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: #10b981;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin: 5px;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .status.calling {
            background: #f59e0b;
            color: white;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¥ CallerN Video Call Test</h1>
        <div id="status-bar">
            <span id="auth-status" class="status disconnected">Not Logged In</span>
            <span id="socket-status" class="status disconnected">Socket Disconnected</span>
            <span id="call-status" class="status disconnected">No Call</span>
        </div>
    </div>
    
    <div class="test-controls">
        <button id="login-student" class="btn btn-student" onclick="loginAsStudent()">
            Login as Student
        </button>
        <button id="login-teacher" class="btn btn-teacher" onclick="loginAsTeacher()">
            Login as Teacher
        </button>
        <button id="start-call" class="btn btn-call" onclick="startCall()" disabled>
            ðŸ“ž Start Call
        </button>
        <button id="accept-call" class="btn btn-call" onclick="acceptCall()" disabled style="display:none;">
            âœ… Accept Call
        </button>
    </div>
    
    <div class="videos-container">
        <div class="video-box">
            <h3>Local Video</h3>
            <div class="video-wrapper">
                <div class="video-label">You</div>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
        </div>
        
        <div class="video-box">
            <h3>Remote Video</h3>
            <div class="video-wrapper">
                <div class="video-label">Remote User</div>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
    </div>
    
    <div class="logs">
        <h3>System Logs</h3>
        <div class="logs-content" id="logs"></div>
    </div>
    
    <script>
        let socket = null;
        let peer = null;
        let localStream = null;
        let currentUser = null;
        let roomId = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            const logsEl = document.getElementById('logs');
            logsEl.textContent += logEntry;
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(elementId, status, text) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = `status ${status}`;
                el.textContent = text || el.textContent;
            }
        }
        
        async function loginAsStudent() {
            log('Logging in as Student...');
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'student1@test.com', password: 'Test@123' })
            });
            
            const data = await response.json();
            if (data.user) {
                currentUser = data.user;
                localStorage.setItem('auth_token', data.auth_token);
                log(`âœ“ Logged in as Student: ${currentUser.firstName}`);
                updateStatus('auth-status', 'connected', `Student: ${currentUser.firstName}`);
                connectSocket();
                document.getElementById('start-call').disabled = false;
            }
        }
        
        async function loginAsTeacher() {
            log('Logging in as Teacher...');
            const response = await fetch('http://localhost:5000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'teacher1@test.com', password: 'password' })
            });
            
            const data = await response.json();
            if (data.user) {
                currentUser = data.user;
                localStorage.setItem('auth_token', data.auth_token);
                log(`âœ“ Logged in as Teacher: ${currentUser.firstName}`);
                updateStatus('auth-status', 'connected', `Teacher: ${currentUser.firstName}`);
                connectSocket();
                document.getElementById('accept-call').style.display = 'inline-block';
            }
        }
        
        function connectSocket() {
            if (socket) socket.disconnect();
            
            log('Connecting to WebSocket...');
            updateStatus('socket-status', 'calling', 'Connecting...');
            
            socket = io('http://localhost:5000', {
                path: '/socket.io/',
                transports: ['websocket']
            });
            
            socket.on('connect', () => {
                log('âœ“ WebSocket connected');
                updateStatus('socket-status', 'connected', 'Socket Connected');
                
                socket.emit('authenticate', {
                    userId: currentUser.id,
                    role: currentUser.role
                });
            });
            
            socket.on('authenticated', (data) => {
                log(`âœ“ Authenticated as ${data.role}`);
            });
            
            socket.on('call-request', (data) => {
                log(`ðŸ“ž Incoming call from student ${data.studentId}`);
                roomId = data.roomId;
                document.getElementById('accept-call').disabled = false;
                updateStatus('call-status', 'calling', 'Incoming Call');
            });
            
            socket.on('call-accepted', async (data) => {
                log('âœ“ Call accepted!');
                roomId = data.roomId;
                updateStatus('call-status', 'connected', 'Call Active');
                
                // Student initiates WebRTC
                if (currentUser.role === 'Student') {
                    await setupWebRTC(true);
                }
            });
            
            socket.on('offer', async (data) => {
                log('ðŸ“¡ Received WebRTC offer');
                if (!peer) {
                    await setupWebRTC(false);
                }
                if (peer && data.offer) {
                    peer.signal(data.offer);
                }
            });
            
            socket.on('answer', async (data) => {
                log('ðŸ“¡ Received WebRTC answer');
                if (peer && data.answer) {
                    peer.signal(data.answer);
                }
            });
            
            socket.on('ice-candidate', async (data) => {
                log('ðŸ§Š Received ICE candidate');
                if (peer && data.candidate) {
                    peer.signal(data.candidate);
                }
            });
            
            socket.on('disconnect', () => {
                log('âœ— WebSocket disconnected');
                updateStatus('socket-status', 'disconnected', 'Socket Disconnected');
            });
        }
        
        async function startCall() {
            if (!socket || currentUser.role !== 'Student') return;
            
            roomId = `test-room-${Date.now()}`;
            log(`Starting call with room: ${roomId}`);
            
            // Get user media first
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                log('âœ“ Got local media');
            } catch (err) {
                log(`âœ— Media error: ${err.message}`);
                return;
            }
            
            // Join room
            socket.emit('join-room', {
                roomId: roomId,
                userId: currentUser.id,
                role: 'student'
            });
            
            // Request call
            socket.emit('call-teacher', {
                teacherId: 73,
                studentId: currentUser.id,
                packageId: 1,
                language: 'english',
                roomId: roomId
            });
            
            updateStatus('call-status', 'calling', 'Calling Teacher...');
        }
        
        async function acceptCall() {
            if (!socket || !roomId || currentUser.role !== 'Teacher') return;
            
            log('Accepting call...');
            
            // Get user media first
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                log('âœ“ Got local media');
            } catch (err) {
                log(`âœ— Media error: ${err.message}`);
                return;
            }
            
            // Join room
            socket.emit('join-room', {
                roomId: roomId,
                userId: currentUser.id,
                role: 'teacher'
            });
            
            // Accept call
            socket.emit('accept-call', {
                roomId: roomId,
                teacherId: currentUser.id,
                studentId: 8469
            });
            
            updateStatus('call-status', 'connected', 'Call Active');
            
            // Teacher waits for offer from student
            log('Waiting for student to initiate WebRTC...');
        }
        
        async function setupWebRTC(isInitiator) {
            log(`Setting up WebRTC as ${isInitiator ? 'initiator' : 'receiver'}`);
            
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    document.getElementById('localVideo').srcObject = localStream;
                    log('âœ“ Got local media');
                } catch (err) {
                    log(`âœ— Media error: ${err.message}`);
                    return;
                }
            }
            
            // Create peer connection
            peer = new SimplePeer({
                initiator: isInitiator,
                stream: localStream,
                trickle: true,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('signal', (signal) => {
                log(`ðŸ“¤ Sending ${signal.type || 'ICE candidate'}`);
                
                if (signal.type === 'offer') {
                    socket.emit('offer', {
                        roomId: roomId,
                        offer: signal
                    });
                } else if (signal.type === 'answer') {
                    socket.emit('answer', {
                        roomId: roomId,
                        answer: signal
                    });
                } else if (signal.candidate) {
                    socket.emit('ice-candidate', {
                        roomId: roomId,
                        candidate: signal
                    });
                }
            });
            
            peer.on('stream', (remoteStream) => {
                log('ðŸŽ‰ Remote stream received!');
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
            
            peer.on('connect', () => {
                log('âœ“ Peer connection established!');
            });
            
            peer.on('error', (err) => {
                log(`âœ— Peer error: ${err}`);
            });
            
            peer.on('close', () => {
                log('Peer connection closed');
            });
        }
        
        // Initialize
        log('CallerN Test System Ready');
        log('1. Login as Student in one browser tab');
        log('2. Login as Teacher in another tab (or incognito)');
        log('3. Student clicks "Start Call"');
        log('4. Teacher clicks "Accept Call"');
    </script>
</body>
</html>
