<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallerN Live Scoring Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .test-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .video-wrapper {
            position: relative;
            background: #1e293b;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        
        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 1.2em;
        }
        
        /* Scoring Overlay Styles */
        .scoring-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 15px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .scoring-overlay.collapsed {
            right: auto;
            width: auto;
            padding: 8px 12px;
        }
        
        .scoring-overlay.collapsed .scoring-content {
            display: none;
        }
        
        .show-button {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            display: none;
        }
        
        .scoring-overlay.collapsed .show-button {
            display: inline-block;
        }
        
        .scoring-overlay.collapsed .scoring-header {
            margin-bottom: 0;
        }
        
        .scoring-overlay.collapsed .scoring-toggle {
            display: none !important;
        }
        
        .scoring-overlay.collapsed .scoring-title {
            display: none !important;
        }
        
        .scoring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .scoring-title {
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .scoring-toggle {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .score-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .score-label {
            font-size: 0.8em;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .score-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .score-bar {
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .ttt-monitor {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .ttt-title {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 10px;
        }
        
        .ttt-bars {
            display: flex;
            gap: 10px;
        }
        
        .ttt-bar {
            flex: 1;
            background: rgba(30, 41, 59, 0.5);
            padding: 10px;
            border-radius: 8px;
        }
        
        .ttt-percentage {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .ttt-bar.warning {
            border: 1px solid rgba(251, 146, 60, 0.5);
            background: rgba(251, 146, 60, 0.1);
        }
        
        .ttt-bar.warning .ttt-percentage {
            color: #fb923c;
        }
        
        .presence-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .presence-badge {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
        }
        
        .presence-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .presence-icon.off {
            background: #ef4444;
        }
        
        .log-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid #3b82f6;
            background: #f1f5f9;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry.success {
            border-left-color: #10b981;
            background: #dcfce7;
        }
        
        .log-entry.warning {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä CallerN Live Scoring System Test</h1>
        
        <div class="test-controls">
            <button class="button" onclick="startCall()">üìû Start Call</button>
            <button class="button" onclick="simulateScoring()">üìà Simulate Scoring</button>
            <button class="button" onclick="testTTTWarning()">‚ö†Ô∏è Test TTT Warning</button>
            <button class="button" onclick="togglePresence()">üé• Toggle Camera/Mic</button>
            <button class="button success" onclick="testHighScores()">üåü High Performance</button>
            <button class="button danger" onclick="endCall()">üìµ End Call</button>
        </div>
        
        <div class="video-container">
            <!-- Student Video with Scoring Overlay -->
            <div class="video-wrapper">
                <div class="video-placeholder">Student Video Stream</div>
                <div class="scoring-overlay" id="student-scoring">
                    <div class="scoring-header">
                        <span class="scoring-title">üìö Student Performance</span>
                        <button class="scoring-toggle" onclick="toggleScoring('student')">Hide</button>
                        <button class="show-button" onclick="toggleScoring('student')">üìä Show Scores</button>
                    </div>
                    <div class="scoring-content">
                    <div class="scoring-grid">
                        <div class="score-item">
                            <div class="score-label">Speaking Fluency</div>
                            <div class="score-value" id="student-fluency">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="student-fluency-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Pronunciation</div>
                            <div class="score-value" id="student-pronunciation">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="student-pronunciation-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Grammar</div>
                            <div class="score-value" id="student-grammar">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="student-grammar-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Vocabulary</div>
                            <div class="score-value" id="student-vocabulary">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="student-vocabulary-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="ttt-monitor">
                        <div class="ttt-title">Talk Time Tracking (TTT)</div>
                        <div class="ttt-bars">
                            <div class="ttt-bar" id="student-ttt-bar">
                                <div class="ttt-percentage" id="student-ttt">60%</div>
                                <div class="score-label">Student Talk Time</div>
                            </div>
                            <div class="ttt-bar" id="teacher-ttt-bar">
                                <div class="ttt-percentage" id="teacher-ttt">40%</div>
                                <div class="score-label">Teacher Talk Time</div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="presence-indicator">
                    <div class="presence-badge">
                        <div class="presence-icon" id="student-camera"></div>
                        <span>Camera</span>
                    </div>
                    <div class="presence-badge">
                        <div class="presence-icon" id="student-mic"></div>
                        <span>Mic</span>
                    </div>
                </div>
            </div>
            
            <!-- Teacher Video with Scoring Overlay -->
            <div class="video-wrapper">
                <div class="video-placeholder">Teacher Video Stream</div>
                <div class="scoring-overlay" id="teacher-scoring">
                    <div class="scoring-header">
                        <span class="scoring-title">üë®‚Äçüè´ Teacher Performance</span>
                        <button class="scoring-toggle" onclick="toggleScoring('teacher')">Hide</button>
                        <button class="show-button" onclick="toggleScoring('teacher')">üìä Show Scores</button>
                    </div>
                    <div class="scoring-content">
                    <div class="scoring-grid">
                        <div class="score-item">
                            <div class="score-label">Facilitator</div>
                            <div class="score-value" id="teacher-facilitator">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="teacher-facilitator-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Engagement</div>
                            <div class="score-value" id="teacher-engagement">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="teacher-engagement-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Feedback</div>
                            <div class="score-value" id="teacher-feedback">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="teacher-feedback-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Assessment</div>
                            <div class="score-value" id="teacher-assessment">0</div>
                            <div class="score-bar">
                                <div class="score-fill" id="teacher-assessment-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="presence-indicator">
                    <div class="presence-badge">
                        <div class="presence-icon" id="teacher-camera"></div>
                        <span>Camera</span>
                    </div>
                    <div class="presence-badge">
                        <div class="presence-icon" id="teacher-mic"></div>
                        <span>Mic</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="log-container" id="log">
            <div class="log-entry">System ready. Click "Start Call" to begin testing.</div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let isCallActive = false;
        let scoringInterval = null;
        const roomId = `test-scoring-${Date.now()}`;
        
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function startCall() {
            if (isCallActive) {
                addLog('Call already active', 'warning');
                return;
            }
            
            isCallActive = true;
            addLog('Initializing WebSocket connection...', 'info');
            
            // Connect socket
            socket = io({
                path: '/socket.io/',
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                addLog(`Socket connected: ${socket.id}`, 'success');
                
                // Authenticate as student
                socket.emit('authenticate', {
                    userId: 8469,
                    role: 'Student'
                });
            });
            
            socket.on('authenticated', () => {
                addLog('Authentication successful', 'success');
                
                // Join room
                socket.emit('join-room', {
                    roomId: roomId,
                    userId: 8469,
                    role: 'student'
                });
                
                addLog(`Joined room: ${roomId}`, 'success');
                
                // Set up scoring event listeners
                setupScoringListeners();
            });
            
            socket.on('error', (error) => {
                addLog(`Socket error: ${error.message || error}`, 'error');
            });
        }
        
        function setupScoringListeners() {
            // Listen for scoring updates
            socket.on('scoring-update', (data) => {
                addLog(`Scoring update received: Student ${data.scores.student}, Teacher ${data.scores.teacher}`, 'info');
                updateScores(data.scores);
            });
            
            // Listen for TTT updates
            socket.on('ttt-update', (data) => {
                addLog(`TTT update: Student ${data.studentPercentage}%, Teacher ${data.teacherPercentage}%`, 'info');
                updateTTT(data);
            });
            
            // Listen for presence updates
            socket.on('presence-update', (data) => {
                addLog(`Presence update: Camera ${data.cameraOn ? 'ON' : 'OFF'}, Mic ${data.micOn ? 'ON' : 'OFF'}`, 'info');
                updatePresence(data);
            });
            
            // Listen for TL warnings
            socket.on('tl-warning', (data) => {
                addLog(`‚ö†Ô∏è Target Language Warning: ${data.message}`, 'warning');
                showTLWarning(data.message);
            });
            
            addLog('Scoring listeners configured', 'success');
        }
        
        function simulateScoring() {
            if (!isCallActive) {
                addLog('Please start a call first', 'warning');
                return;
            }
            
            addLog('Starting scoring simulation...', 'info');
            
            let studentScores = {
                fluency: 0,
                pronunciation: 0,
                grammar: 0,
                vocabulary: 0
            };
            
            let teacherScores = {
                facilitator: 0,
                engagement: 0,
                feedback: 0,
                assessment: 0
            };
            
            scoringInterval = setInterval(() => {
                // Increment scores randomly
                studentScores.fluency = Math.min(100, studentScores.fluency + Math.random() * 10);
                studentScores.pronunciation = Math.min(100, studentScores.pronunciation + Math.random() * 8);
                studentScores.grammar = Math.min(100, studentScores.grammar + Math.random() * 7);
                studentScores.vocabulary = Math.min(100, studentScores.vocabulary + Math.random() * 9);
                
                teacherScores.facilitator = Math.min(100, teacherScores.facilitator + Math.random() * 9);
                teacherScores.engagement = Math.min(100, teacherScores.engagement + Math.random() * 10);
                teacherScores.feedback = Math.min(100, teacherScores.feedback + Math.random() * 8);
                teacherScores.assessment = Math.min(100, teacherScores.assessment + Math.random() * 7);
                
                // Update UI
                updateStudentScores(studentScores);
                updateTeacherScores(teacherScores);
                
                // Emit scoring update
                if (socket && socket.connected) {
                    socket.emit('scoring-update', {
                        roomId: roomId,
                        scores: {
                            student: Math.round((studentScores.fluency + studentScores.pronunciation + studentScores.grammar + studentScores.vocabulary) / 4),
                            teacher: Math.round((teacherScores.facilitator + teacherScores.engagement + teacherScores.feedback + teacherScores.assessment) / 4)
                        }
                    });
                }
                
                // Stop when all scores reach 100
                if (studentScores.fluency >= 100 && teacherScores.engagement >= 100) {
                    clearInterval(scoringInterval);
                    addLog('Scoring simulation complete', 'success');
                }
            }, 1000);
        }
        
        function updateStudentScores(scores) {
            document.getElementById('student-fluency').textContent = Math.round(scores.fluency);
            document.getElementById('student-fluency-bar').style.width = scores.fluency + '%';
            
            document.getElementById('student-pronunciation').textContent = Math.round(scores.pronunciation);
            document.getElementById('student-pronunciation-bar').style.width = scores.pronunciation + '%';
            
            document.getElementById('student-grammar').textContent = Math.round(scores.grammar);
            document.getElementById('student-grammar-bar').style.width = scores.grammar + '%';
            
            document.getElementById('student-vocabulary').textContent = Math.round(scores.vocabulary);
            document.getElementById('student-vocabulary-bar').style.width = scores.vocabulary + '%';
        }
        
        function updateTeacherScores(scores) {
            document.getElementById('teacher-facilitator').textContent = Math.round(scores.facilitator);
            document.getElementById('teacher-facilitator-bar').style.width = scores.facilitator + '%';
            
            document.getElementById('teacher-engagement').textContent = Math.round(scores.engagement);
            document.getElementById('teacher-engagement-bar').style.width = scores.engagement + '%';
            
            document.getElementById('teacher-feedback').textContent = Math.round(scores.feedback);
            document.getElementById('teacher-feedback-bar').style.width = scores.feedback + '%';
            
            document.getElementById('teacher-assessment').textContent = Math.round(scores.assessment);
            document.getElementById('teacher-assessment-bar').style.width = scores.assessment + '%';
        }
        
        function updateTTT(data) {
            document.getElementById('student-ttt').textContent = data.studentPercentage + '%';
            document.getElementById('teacher-ttt').textContent = data.teacherPercentage + '%';
            
            // Add warning class if imbalanced
            const studentBar = document.getElementById('student-ttt-bar');
            const teacherBar = document.getElementById('teacher-ttt-bar');
            
            if (data.studentPercentage < 40) {
                studentBar.classList.add('warning');
                addLog('‚ö†Ô∏è Student talk time below 40%', 'warning');
            } else {
                studentBar.classList.remove('warning');
            }
            
            if (data.teacherPercentage > 60) {
                teacherBar.classList.add('warning');
                addLog('‚ö†Ô∏è Teacher talk time above 60%', 'warning');
            } else {
                teacherBar.classList.remove('warning');
            }
        }
        
        function testTTTWarning() {
            if (!isCallActive) {
                addLog('Please start a call first', 'warning');
                return;
            }
            
            // Simulate imbalanced talk time
            const imbalancedData = {
                studentPercentage: 25,
                teacherPercentage: 75
            };
            
            updateTTT(imbalancedData);
            
            if (socket && socket.connected) {
                socket.emit('ttt-update', {
                    roomId: roomId,
                    ...imbalancedData
                });
            }
            
            addLog('Testing TTT warning with imbalanced talk time', 'warning');
        }
        
        function togglePresence() {
            const cameraIcons = [
                document.getElementById('student-camera'),
                document.getElementById('teacher-camera')
            ];
            const micIcons = [
                document.getElementById('student-mic'),
                document.getElementById('teacher-mic')
            ];
            
            cameraIcons.forEach(icon => {
                icon.classList.toggle('off');
            });
            
            micIcons.forEach(icon => {
                icon.classList.toggle('off');
            });
            
            const cameraOn = !cameraIcons[0].classList.contains('off');
            const micOn = !micIcons[0].classList.contains('off');
            
            if (socket && socket.connected) {
                socket.emit('presence-update', {
                    roomId: roomId,
                    cameraOn: cameraOn,
                    micOn: micOn
                });
            }
            
            addLog(`Presence toggled: Camera ${cameraOn ? 'ON' : 'OFF'}, Mic ${micOn ? 'ON' : 'OFF'}`, 'info');
        }
        
        function updatePresence(data) {
            const studentCamera = document.getElementById('student-camera');
            const studentMic = document.getElementById('student-mic');
            
            if (data.cameraOn) {
                studentCamera.classList.remove('off');
            } else {
                studentCamera.classList.add('off');
            }
            
            if (data.micOn) {
                studentMic.classList.remove('off');
            } else {
                studentMic.classList.add('off');
            }
        }
        
        function testHighScores() {
            if (!isCallActive) {
                addLog('Please start a call first', 'warning');
                return;
            }
            
            addLog('Testing high performance scores...', 'success');
            
            const highScores = {
                student: {
                    fluency: 95,
                    pronunciation: 92,
                    grammar: 88,
                    vocabulary: 90
                },
                teacher: {
                    facilitator: 93,
                    engagement: 96,
                    feedback: 91,
                    assessment: 89
                }
            };
            
            updateStudentScores(highScores.student);
            updateTeacherScores(highScores.teacher);
            
            // Update TTT to ideal balance
            updateTTT({
                studentPercentage: 60,
                teacherPercentage: 40
            });
            
            addLog('üåü Excellent performance! Student: 91/100, Teacher: 92/100', 'success');
        }
        
        function toggleScoring(role) {
            const overlay = document.getElementById(`${role}-scoring`);
            const hideButton = overlay.querySelector('.scoring-toggle');
            const showButton = overlay.querySelector('.show-button');
            const title = overlay.querySelector('.scoring-title');
            
            if (overlay.classList.contains('collapsed')) {
                // Expand
                overlay.classList.remove('collapsed');
                hideButton.style.display = 'inline-block';
                showButton.style.display = 'none';
                title.style.display = 'inline';
            } else {
                // Collapse
                overlay.classList.add('collapsed');
                hideButton.style.display = 'none';
                showButton.style.display = 'inline-block';
                title.style.display = 'none';
            }
        }
        
        function showTLWarning(message) {
            // Flash the TTT monitor to show warning
            const tttMonitor = document.querySelector('.ttt-monitor');
            tttMonitor.style.borderColor = '#fb923c';
            tttMonitor.style.backgroundColor = 'rgba(251, 146, 60, 0.1)';
            
            setTimeout(() => {
                tttMonitor.style.borderColor = '';
                tttMonitor.style.backgroundColor = '';
            }, 3000);
        }
        
        function endCall() {
            if (!isCallActive) {
                addLog('No active call to end', 'warning');
                return;
            }
            
            isCallActive = false;
            
            if (scoringInterval) {
                clearInterval(scoringInterval);
            }
            
            if (socket) {
                socket.emit('end-call', { roomId: roomId });
                socket.disconnect();
                socket = null;
            }
            
            addLog('Call ended', 'error');
            
            // Reset scores
            updateStudentScores({ fluency: 0, pronunciation: 0, grammar: 0, vocabulary: 0 });
            updateTeacherScores({ facilitator: 0, engagement: 0, feedback: 0, assessment: 0 });
            updateTTT({ studentPercentage: 60, teacherPercentage: 40 });
        }
    </script>
</body>
</html>