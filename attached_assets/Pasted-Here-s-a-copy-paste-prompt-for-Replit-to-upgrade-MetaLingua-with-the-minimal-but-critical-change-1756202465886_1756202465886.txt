Here‚Äôs a **copy-paste prompt** for Replit to upgrade MetaLingua with the minimal but critical changes we discussed. Paste it into your Replit Agent:

---

# üöÄ META PROMPT FOR REPLIT ‚Äî MetaLingua Adaptive Roadmap + Callern vs. Online 1:1 Enhancements (Self-Hosted, No Mocks)

**READ FIRST ‚Äî MANDATORY WORKFLOW**

1. **Review the entire codebase first (frontend, backend, infra, scripts, CI).**

   * Detect what already exists to **avoid duplication**.
   * Generate a brief **inventory** (services, packages, ports, env vars, DB schemas, queues, cron jobs, docker compose, systemd units).
   * Map current features to the list below and mark which are already implemented vs. missing.

2. **Plan changes**: produce a step-by-step implementation plan (bullet list) with file paths you‚Äôll touch, DB migrations, new endpoints, and test strategy.

3. **Self-hosted only. No mock/fake endpoints.**

   * Use real, locally running services via Docker Compose (PostgreSQL, Ollama, Whisper, Piper, Redis/Queue, WebRTC TURN, etc.).
   * For SMS/email push, prefer **self-hosted** adapters (e.g., local SMTP container, local SMS gateway) behind our provider-agnostic interfaces.
   * For VoIP and Callern (WebRTC), use existing stack (SimplePeer/WebRTC) and TURN. If Asterisk/Issabel interop exists, keep it behind a feature flag.
   * All tests must hit **real local services** (containers) end-to-end.

4. **Implement**, then **create tests (unit, integration, e2e, load)**, wire into CI, and **document**.

5. **Deliverables**: code changes + migrations + updated `.env.example` + Docker Compose for new services + docs + test suites + a short CHANGELOG.

---

## PRODUCT CONTEXT (DO NOT SKIP)

* Two primary lesson delivery modes that must be supported distinctly:

  **A) Callern (24/7, 10-20 min micro-sessions, teacher not fixed):**

  * On demand, no fixed schedule.
  * Each answering teacher receives a **pre-call briefing** about the student (roadmap objective, last session outcomes, IRT metrics, errors, current targets).
  * Strict **session timer** and **post-session auto-bundle** (personalized content package).
  * Designed for **super busy users**.

  **B) Online Live One-on-One (60/90 min, scheduled, fixed teacher):**

  * Fixed time/day/teacher.
  * Full-length session with **deep coverage** of roadmap objectives.
  * Pre-class dashboard for teacher; post-class personalized content bundle for student.

* Roadmap (titles & objectives) is defined up-front, but **content must be generated session-by-session** based on **IRT** from actual performance.

* AI stack is **self-hosted**: **Ollama (Llama 3.2)** for NLG, **Whisper/faster-whisper** for ASR, **Piper** for Farsi TTS (voice quality), TURN for WebRTC, local SMTP/SMS gateway, PostgreSQL.

* Technologies already in project (keep them): Express.js + TypeScript, PostgreSQL (Drizzle), React 18 + TS + Tailwind + shadcn/ui, Socket.io, WebRTC (SimplePeer), Docker, self-hosting on Linux.

---

## REQUIRED CHANGES (MINIMAL, FOCUSED)

### 1) **Advanced Roadmap Editor (Frontend + API)**

* Upgrade the existing curriculum/roadmap editor to support:

  * **Rich-text editing** (keep Tailwind/shadcn UI), drag-drop objective ordering.
  * **Objective tags**: CEFR level, skill (speaking/listening/reading/writing), **generation rules** (e.g., ‚ÄúC1 Business Vocab ‚Üí include collocations, idioms, word families, formal register‚Äù).
  * **Link objectives ‚Üí generation policy** that the AI engine reads at runtime.
* API:

  * `PUT /roadmap/:id/objectives` ‚Äî accepts objectives with `tags[]` and `generationPolicy{}`.
  * Validation via Zod/TypeBox. DB migration to add `tags jsonb`, `generation_policy jsonb`.

### 2) **Session-Adaptive Content Generator (Backend service)**

* New service/module `services/adaptive-kit/`:

  * Inputs: **session transcript/metrics (from Callern or Live 1:1)** + **roadmap objective + IRT scores**.
  * Outputs: a **Lesson Kit** saved in DB + file store:

    * **Audio**: TTS via **Piper** (Farsi) using objective & IRT difficulty.
    * **Reading passage**: generated by **Ollama** to target level/objective; store text + CEFR annotations.
    * **Grammar snippet**: short explanation matched to errors.
    * **Exercises**: at least 3 types (gap-fill, sentence transform, collocations/idioms).
    * **Mini-game**: simple data model (e.g., drag-drop JSON spec) rendered by front-end game component.
  * Use real API calls to **Ollama**, **Whisper (for reference checks if needed)**, **Piper**.
  * Store assets: `/content/<studentId>/<sessionId>/...` with DB pointers.

* API:

  * `POST /sessions/:id/generate-kit` ‚Üí kicks off generation (queue + worker).
  * `GET /sessions/:id/kit` ‚Üí returns kit manifest + asset URLs.

* Infra:

  * Add queue (Redis + BullMQ or equivalent already used).
  * Add **Docker compose** services for `ollama`, `faster-whisper-server`, `piper-http`, `redis` if missing.
  * Add health checks and retry logic.

### 3) **Callern Enhancements (24/7 micro-sessions)**

* **Teacher Briefing API** (before answer):

  * `GET /callern/briefing?studentId=...` returns compact briefing:

    * Roadmap objective(s) due today/this week
    * Last 3 session highlights, IRT scores, top errors, target vocab list
    * Suggested micro-goals for this 10-20 min slot

* **Session Timer & Flow**:

  * Enforce **10‚Äì20 min** max (config). Visible countdown in teacher UI.
  * Auto-end with polite wrap-up.
  * Auto-trigger `POST /sessions/:id/generate-kit`.

* **Teacher Allocation Logic**:

  * If not fixed, **match** available teacher by skill, rating, language.
  * Implement cooldown and max concurrency.
  * Log who answered + performance.

* **Post-Session Summary**:

  * Store transcript, TTT ratio, errors.
  * Push **personalized kit** to student dashboard immediately.

### 4) **Online Live 1:1 Enhancements (60/90 min, scheduled, fixed teacher)**

* Pre-class **Teacher Dashboard**:

  * Roadmap objective(s), last session kit completion, IRT deltas, predicted weak areas.
* Post-class: same **kit generation** pipeline as Callern, but longer form and richer assets (configurable by lesson length).
* Schedule service sanity: ensure **fixed teacher + fixed time** is enforced with conflict checks already in system.

### 5) **Teacher Supervision Mode (Quiet Reminders)**

* Implement a **real-time reminder engine** driven by the roadmap objective‚Äôs `generationPolicy`:

  * In class, if objective ‚ÄúC1 Business Vocab‚Äù, prompt the teacher UI to cover **collocations, idioms, word families, register** if omitted.
  * Store missed items ‚Üí QA dashboard item with timestamp.

### 6) **IRT Integration**

* Add/extend **IRT scoring** tables: item difficulty, discrimination, student ability Œ∏, SE.
* After each session, update Œ∏ and **use Œ∏ to select difficulty** for next kit generation.
* API: `POST /irt/update` (internal) called from session pipeline.

### 7) **Student Delivery**

* Add ‚Äú**Today‚Äôs Personalized Bundle**‚Äù card in student dashboard:

  * Audio player, reading passage viewer (with highlighted vocab), 3 exercises, 1 mini-game.
  * Completion writes back to analytics.

---

## TESTING (NO MOCKS ‚Äî REAL LOCAL SERVICES)

* **Docker Compose** for test stack (`docker-compose.test.yml`):

  * postgres, redis, ollama, faster-whisper, piper, turn-server (coturn), smtp (mailhog), sms-gateway (local container).
  * Use **real API calls** to these containers.

* **Tests**:

  1. **Unit** (TS/Jest) for pure logic (generationPolicy parser, IRT math, allocation rules).
  2. **Integration**:

     * `POST /sessions/:id/generate-kit` hits Ollama/Piper and stores assets.
     * Callern briefing returns correct objective & IRT data.
     * Timer ends session and triggers kit generation.
  3. **E2E** (Playwright/Cypress):

     * Simulate Callern micro-session ‚Üí see kit appear in student dashboard.
     * Simulate scheduled 1:1 ‚Üí pre-class dashboard populated ‚Üí after class, kit delivered.
  4. **Load** (k6/Artillery):

     * Concurrent kit generations (e.g., 50) within acceptable latency; resource usage logged.
  5. **Security**:

     * RBAC on all new endpoints; only authorized roles can trigger or fetch kits.
  6. **Data**:

     * Migrations forward/backward.
     * `.env.example` updated with sane defaults.

---

## ACCEPTANCE CRITERIA

* Roadmap editor supports tags + generation policy; persisted in DB.
* Callern:

  * Briefing API returns correct student-specific data.
  * Session timer enforced (configurable 10‚Äì20 min).
  * Auto kit generation succeeds and assets playable/usable.
* Online 1:1:

  * Fixed teacher/time honored; pre-class dashboard displays analytics.
  * Post-class kit generated with length-appropriate content.
* Teacher supervision reminders appear contextually and log missed items.
* IRT Œ∏ updates after sessions and **modulates** next kit difficulty.
* All tests green in CI; no mocks; services run locally via Docker.
* Documentation updated (README + /docs/\*.md), including:

  * New env vars, ports, docker services
  * API contracts for new endpoints
  * How to run the test stack end-to-end
* No duplication of existing modules; reuse current patterns and libs.

---

## IMPLEMENTATION GUARDRAILS

* Prefer **feature flags** where changes touch critical paths.
* Backward compatible DB migrations (Drizzle).
* Do not introduce cloud dependencies; everything must run on local Linux servers.
* Keep code style consistent (ESLint/Prettier configs already in repo).
* Commit in logical slices with clear messages; open a PR with a human-readable summary.

---

**Now do the following:**

1. Produce the **codebase review inventory**.
2. Write the **implementation plan**.
3. Implement features **in small commits**.
4. Add **Docker Compose** services needed and wire health checks.
5. Add **tests** (unit/integration/e2e/load) that hit local services.
6. Update **docs and .env.example**.
7. Run full test suite and output **final status** with instructions to run locally in production mode.

---

**Output format** (at each major step):

* `### Inventory`
* `### Plan`
* `### Changes (summary + file paths)`
* `### How to Run (dev/test/prod)`
* `### Test Results`
* `### Known Limitations & Next Steps`

---

That‚Äôs it. Proceed.

---

Done.
